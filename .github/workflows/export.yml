name: WCA database export

on:
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest

    env:
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: wca

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download and extract WCA database
        run: bash scripts/download.sh

      - name: Run docker-compose
        uses: hoverkraft-tech/compose-action@v2.0.1

      - name: Populate database
        run: bash scripts/populate.sh

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Export data
        run: deno run -A src/main.ts

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: "data"
          commit-message: "update: wca data"
          title: "upate: WCA data"
          body: "Auto-generated by `create-pull-request`"
          branch: update-wca-data
